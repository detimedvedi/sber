"""
–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
–¢–µ–º–∞: "–û —ç—Ç–æ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π, —Å—Ç—Ä–∞–Ω–Ω—ã–π –º–∏—Ä"

–¶–µ–ª—å: –û—Ç–æ–±—Ä–∞—Ç—å —Å–∞–º—ã–µ –ù–ï–û–ë–´–ß–ù–´–ï –∏ –ò–ù–¢–ï–†–ï–°–ù–´–ï –∞–Ω–æ–º–∞–ª–∏–∏ —Å –¥–∞—Ç–∞-–∏—Å—Ç–æ—Ä–∏—è–º–∏
"""

import pandas as pd
import json

print("=" * 80)
print("üé® –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò")
print("–¢–µ–º–∞: '–û —ç—Ç–æ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π, —Å—Ç—Ä–∞–Ω–Ω—ã–π –º–∏—Ä'")
print("=" * 80)

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
df = pd.read_csv('output/anomalies_master_20251104_022850.csv')

print(f"\nüìä –í—Å–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∞–Ω–æ–º–∞–ª–∏–π: {len(df):,}")
print(f"üìç –ó–∞—Ç—Ä–æ–Ω—É—Ç–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤: {df['territory_id'].nunique():,}")

# ============================================================================
# –ö–†–ò–¢–ï–†–ò–ô 1: –°–∞–º—ã–µ –°–¢–†–ê–ù–ù–´–ï –∞–Ω–æ–º–∞–ª–∏–∏ (–Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)
# ============================================================================

print("\n" + "=" * 80)
print("ü§î –ö–†–ò–¢–ï–†–ò–ô 1: –°–∞–º—ã–µ –°–¢–†–ê–ù–ù–´–ï –∞–Ω–æ–º–∞–ª–∏–∏")
print("=" * 80)

# 1.1 Cross-source discrepancies - —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å –∏ –†–æ—Å—Å—Ç–∞—Ç
cross_source = df[df['anomaly_type'] == 'cross_source_discrepancy'].copy()
print(f"\n1Ô∏è‚É£ –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å vs –†–æ—Å—Å—Ç–∞—Ç: {len(cross_source)} —Å–ª—É—á–∞–µ–≤")
print("   –ò–Ω—Ç–µ—Ä–µ—Å: –ü–æ—á–µ–º—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?")

# –¢–æ–ø-5 –ø–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—é
cross_source['abs_discrepancy'] = abs(cross_source['deviation_pct'])
top_cross = cross_source.nlargest(5, 'abs_discrepancy')[
    ['municipal_name', 'region_name', 'indicator', 'actual_value', 
     'expected_value', 'deviation_pct', 'description']
]
print("\n   –¢–û–ü-5 —Å–∞–º—ã—Ö —Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π:")
for idx, row in top_cross.iterrows():
    print(f"\n   ‚Ä¢ {row['municipal_name']} ({row['region_name']})")
    print(f"     –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å: {row['actual_value']:.1f} vs –†–æ—Å—Å—Ç–∞—Ç: {row['expected_value']:.0f}")
    print(f"     –†–∞–∑–Ω–∏—Ü–∞: {row['deviation_pct']:.1f}%")

# 1.2 Logical inconsistencies - –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
logical = df[df['anomaly_type'] == 'logical_inconsistency'].copy()
print(f"\n2Ô∏è‚É£ –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è: {len(logical)} —Å–ª—É—á–∞–µ–≤")
print("   –ò–Ω—Ç–µ—Ä–µ—Å: –ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞?")

# –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ (–Ω–µ missing data)
logical_interesting = logical[~logical['indicator'].str.contains('missing', case=False, na=False)]
print(f"   –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö (–Ω–µ missing data): {len(logical_interesting)}")

# ============================================================================
# –ö–†–ò–¢–ï–†–ò–ô 2: –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–∫—Å—Ç—Ä–µ–º—É–º—ã
# ============================================================================

print("\n" + "=" * 80)
print("üó∫Ô∏è –ö–†–ò–¢–ï–†–ò–ô 2: –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–∫—Å—Ç—Ä–µ–º—É–º—ã –†–æ—Å—Å–∏–∏")
print("=" * 80)

geographic = df[df['anomaly_type'] == 'geographic_anomaly'].copy()

# –ù–∞–π—Ç–∏ –æ—Ç–¥–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
remote_keywords = ['–ë–∏–ª–∏–±–∏–Ω—Å–∫–∏–π', '–ß—É–∫–æ—Ç', '–ö–æ–º–∞–Ω–¥–æ—Ä', '–ê–Ω–∞–¥—ã—Ä', '–ü–µ–≤–µ–∫', 
                   '–ù–æ—Ä–∏–ª—å—Å–∫', '–û–π–º—è–∫–æ–Ω', '–í–µ—Ä—Ö–æ—è–Ω']
remote = df[df['municipal_name'].str.contains('|'.join(remote_keywords), case=False, na=False)]

print(f"\n3Ô∏è‚É£ –û—Ç–¥–∞–ª—ë–Ω–Ω—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏: {len(remote)} –∞–Ω–æ–º–∞–ª–∏–π")
print("   –ò–Ω—Ç–µ—Ä–µ—Å: –ö–∞–∫ –∂–∏–≤—É—Ç —Å–∞–º—ã–µ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —É–≥–æ–ª–∫–∏ –†–æ—Å—Å–∏–∏?")

if len(remote) > 0:
    remote_top = remote.groupby('municipal_name').agg({
        'anomaly_id': 'count',
        'severity_score': 'mean',
        'region_name': 'first'
    }).sort_values('anomaly_id', ascending=False).head(5)
    
    print("\n   –¢–û–ü-5 —Å–∞–º—ã—Ö –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –æ—Ç–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π:")
    for muni, row in remote_top.iterrows():
        print(f"   ‚Ä¢ {muni} ({row['region_name']}): {row['anomaly_id']} –∞–Ω–æ–º–∞–ª–∏–π")

# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ—Å—Ç—å - —Å—Ç–æ–ª–∏—á–Ω—ã–µ —Ä–∞–π–æ–Ω—ã
capitals = ['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ê—Ä–±–∞—Ç', '–ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π', '–•–∞–º–æ–≤–Ω–∏–∫–∏']
capital_anomalies = df[df['municipal_name'].str.contains('|'.join(capitals), case=False, na=False)]

print(f"\n4Ô∏è‚É£ –°—Ç–æ–ª–∏—á–Ω—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏: {len(capital_anomalies)} –∞–Ω–æ–º–∞–ª–∏–π")
print("   –ò–Ω—Ç–µ—Ä–µ—Å: –ù–∞—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–ª–∏—Ü–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–π –†–æ—Å—Å–∏–∏?")

# ============================================================================
# –ö–†–ò–¢–ï–†–ò–ô 3: –°–∞–º—ã–µ –Ω–µ–æ–±—ã—á–Ω—ã–µ –ü–ê–†–´ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
# ============================================================================

print("\n" + "=" * 80)
print("üîÄ –ö–†–ò–¢–ï–†–ò–ô 3: –ö–æ–Ω—Ç—Ä–∞—Å—Ç—ã –†–æ—Å—Å–∏–∏")
print("=" * 80)

# –ù–∞–π—Ç–∏ –∫—Ä–∞–π–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É
indicators = df['indicator'].value_counts().head(10).index

print("\n5Ô∏è‚É£ –ö–æ–Ω—Ç—Ä–∞—Å—Ç—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º:")

contrasts = []
for indicator in indicators[:3]:  # –¢–æ–ø-3 –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    ind_data = df[df['indicator'] == indicator].copy()
    if len(ind_data) < 2:
        continue
    
    # –ú–∞–∫—Å–∏–º—É–º –∏ –º–∏–Ω–∏–º—É–º
    max_row = ind_data.loc[ind_data['actual_value'].idxmax()]
    min_row = ind_data.loc[ind_data['actual_value'].idxmin()]
    
    ratio = max_row['actual_value'] / min_row['actual_value'] if min_row['actual_value'] != 0 else float('inf')
    
    print(f"\n   üìä {indicator}:")
    print(f"      –ú–∞–∫—Å–∏–º—É–º: {max_row['municipal_name']} = {max_row['actual_value']:.1f}")
    print(f"      –ú–∏–Ω–∏–º—É–º:  {min_row['municipal_name']} = {min_row['actual_value']:.1f}")
    print(f"      –†–∞–∑–Ω–∏—Ü–∞: –≤ {ratio:.1f} —Ä–∞–∑!")
    
    contrasts.append({
        'indicator': indicator,
        'max_municipality': max_row['municipal_name'],
        'max_region': max_row['region_name'],
        'max_value': max_row['actual_value'],
        'min_municipality': min_row['municipal_name'],
        'min_region': min_row['region_name'],
        'min_value': min_row['actual_value'],
        'ratio': ratio
    })

# ============================================================================
# –ö–†–ò–¢–ï–†–ò–ô 4: "–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–µ" –∑–Ω–∞—á–µ–Ω–∏—è (severity = 100)
# ============================================================================

print("\n" + "=" * 80)
print("üö® –ö–†–ò–¢–ï–†–ò–ô 4: '–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–µ' –∑–Ω–∞—á–µ–Ω–∏—è")
print("=" * 80)

critical = df[df['severity_score'] == 100].copy()
print(f"\n6Ô∏è‚É£ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏–π (severity=100): {len(critical)}")
print("   –ò–Ω—Ç–µ—Ä–µ—Å: –û—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏?")

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º
critical_by_indicator = critical['indicator'].value_counts().head(5)
print("\n   –¢–æ–ø-5 –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å '–Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º–∏' –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:")
for indicator, count in critical_by_indicator.items():
    print(f"   ‚Ä¢ {indicator}: {count} —Å–ª—É—á–∞–µ–≤")

# ============================================================================
# –°–û–ó–î–ê–ù–ò–ï –î–ê–¢–ê-–ò–°–¢–û–†–ò–ô
# ============================================================================

print("\n" + "=" * 80)
print("üìñ –°–û–ó–î–ê–ù–ò–ï –î–ê–¢–ê-–ò–°–¢–û–†–ò–ô")
print("=" * 80)

stories = []

# –ò—Å—Ç–æ—Ä–∏—è 1: –ù–æ—Ä–∏–ª—å—Å–∫ - –≥–æ—Ä–æ–¥ –Ω–∞ –∫—Ä–∞—é —Å–≤–µ—Ç–∞
norils = df[df['municipal_name'].str.contains('–ù–æ—Ä–∏–ª—å—Å–∫', case=False, na=False)]
if len(norils) > 0:
    story1 = {
        'title': 'üèîÔ∏è –ù–æ—Ä–∏–ª—å—Å–∫: –ì–æ—Ä–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∏ –Ω–∞ —á—Ç–æ',
        'subtitle': '–°–∞–º—ã–π —Å–µ–≤–µ—Ä–Ω—ã–π –≥–æ—Ä–æ–¥ –ø–ª–∞–Ω–µ—Ç—ã —Å –Ω–∞—Å–µ–ª–µ–Ω–∏–µ–º >100 —Ç—ã—Å.',
        'municipality': '–ù–æ—Ä–∏–ª—å—Å–∫',
        'region': '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π',
        'anomalies_count': len(norils),
        'key_facts': [
            f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(norils)} –∞–Ω–æ–º–∞–ª–∏–π",
            "–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —è–Ω–≤–∞—Ä—è: -28¬∞C",
            "–ü–æ–ª—è—Ä–Ω–∞—è –Ω–æ—á—å: 45 –¥–Ω–µ–π",
            "–ù–∞—Å–µ–ª–µ–Ω–∏–µ: ~180 —Ç—ã—Å. (–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–∞—Ö—Ç–æ–≤–∏–∫–∏)"
        ],
        'data_insights': norils[['indicator', 'actual_value', 'severity_score']].to_dict('records')[:5],
        'narrative': (
            "–ù–æ—Ä–∏–ª—å—Å–∫ - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –≥–æ—Ä–æ–¥, —ç—Ç–æ –¥—Ä—É–≥–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å. "
            "–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞ –ü–æ–ª—è—Ä–Ω—ã–º –∫—Ä—É–≥–æ–º, –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ "
            "–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π. –ù–æ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ - —ç—Ç–æ "
            "–æ–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –∂–∏–∑–Ω–∏ –Ω–∞ –∫—Ä–∞—é —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏."
        ),
        'visualization_suggestion': '–ö–∞—Ä—Ç–∞ –†–æ—Å—Å–∏–∏ —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –ù–æ—Ä–∏–ª—å—Å–∫–∞ + —Ä–∞–¥–∞—Ä-—á–∞—Ä—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π'
    }
    stories.append(story1)
    print("\n‚úì –ò—Å—Ç–æ—Ä–∏—è 1: –ù–æ—Ä–∏–ª—å—Å–∫ —Å–æ–∑–¥–∞–Ω–∞")

# –ò—Å—Ç–æ—Ä–∏—è 2: –ö–æ–Ω—Ç—Ä–∞—Å—Ç —Å—Ç–æ–ª–∏—Ü–∞-–ø–µ—Ä–∏—Ñ–µ—Ä–∏—è
if len(capital_anomalies) > 0 and len(remote) > 0:
    story2 = {
        'title': 'üèõÔ∏è –î–≤–µ –†–æ—Å—Å–∏–∏: –ê—Ä–±–∞—Ç vs –ë–∏–ª–∏–±–∏–Ω–æ',
        'subtitle': '–ö–∞–∫ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã –∏ –ß—É–∫–æ—Ç–∫–∞',
        'municipalities': ['–ê—Ä–±–∞—Ç', '–ë–∏–ª–∏–±–∏–Ω—Å–∫–∏–π'],
        'contrast_data': contrasts,
        'narrative': (
            "–ê—Ä–±–∞—Ç - —Å–∏–º–≤–æ–ª —Å—Ç–æ–ª–∏—á–Ω–æ–π –∂–∏–∑–Ω–∏, –ë–∏–ª–∏–±–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω –Ω–∞ –ß—É–∫–æ—Ç–∫–µ - "
            "—Å–∏–º–≤–æ–ª –¥–∞–ª—ë–∫–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –Ω–∏–º–∏ - —ç—Ç–æ —Ä–∞–∑–Ω–∏—Ü–∞ "
            "–º–µ–∂–¥—É –¥–≤—É–º—è —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∞–º–∏, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –≤ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –æ–¥–Ω–æ–π."
        ),
        'visualization_suggestion': '–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞: –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π'
    }
    stories.append(story2)
    print("‚úì –ò—Å—Ç–æ—Ä–∏—è 2: –ö–æ–Ω—Ç—Ä–∞—Å—Ç —Å—Ç–æ–ª–∏—Ü–∞-–ø–µ—Ä–∏—Ñ–µ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞")

# –ò—Å—Ç–æ—Ä–∏—è 3: –ó–∞–≥–∞–¥–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å vs –†–æ—Å—Å—Ç–∞—Ç
if len(cross_source) > 0:
    top_discrepancy = cross_source.nlargest(1, 'abs_discrepancy').iloc[0]
    story3 = {
        'title': '‚ùì –ó–∞–≥–∞–¥–∫–∞ –¥–≤—É—Ö —Ü–∏—Ñ—Ä',
        'subtitle': f"–ü–æ—á–µ–º—É –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å –∏ –†–æ—Å—Å—Ç–∞—Ç –≤–∏–¥—è—Ç {top_discrepancy['municipal_name']} –ø–æ-—Ä–∞–∑–Ω–æ–º—É?",
        'municipality': top_discrepancy['municipal_name'],
        'sberindex_value': top_discrepancy['actual_value'],
        'rosstat_value': top_discrepancy['expected_value'],
        'discrepancy': top_discrepancy['deviation_pct'],
        'narrative': (
            "–°–±–µ—Ä–ò–Ω–¥–µ–∫—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–¥–Ω–∏ —Ü–∏—Ñ—Ä—ã, –†–æ—Å—Å—Ç–∞—Ç - —Å–æ–≤—Å–µ–º –¥—Ä—É–≥–∏–µ. "
            "–ö—Ç–æ –ø—Ä–∞–≤? –ò–ª–∏ –æ–±–∞ –ø—Ä–∞–≤—ã, –Ω–æ –∏–∑–º–µ—Ä—è—é—Ç —Ä–∞–∑–Ω–æ–µ? "
            "–≠—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –æ —Ç–æ–º, –∫–∞–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–∂–µ—Ç —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å "
            "—Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–± –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ –º–µ—Å—Ç–µ."
        ),
        'visualization_suggestion': '–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ + –∫–∞—Ä—Ç–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π'
    }
    stories.append(story3)
    print("‚úì –ò—Å—Ç–æ—Ä–∏—è 3: –ó–∞–≥–∞–¥–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–∞")

# ============================================================================
# –≠–ö–°–ü–û–†–¢ –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò
# ============================================================================

print("\n" + "=" * 80)
print("üíæ –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò")
print("=" * 80)

# 1. –¢–æ–ø-50 —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π
top50 = df.nlargest(50, 'severity_score')[
    ['municipal_name', 'region_name', 'indicator', 'anomaly_type', 
     'actual_value', 'expected_value', 'deviation_pct', 
     'severity_score', 'description']
]
top50.to_csv('output/viz_top50_anomalies.csv', index=False, encoding='utf-8-sig')
print("\n‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: viz_top50_anomalies.csv (—Ç–æ–ø-50 –∞–Ω–æ–º–∞–ª–∏–π)")

# 2. –ö–æ–Ω—Ç—Ä–∞—Å—Ç—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
contrasts_df = pd.DataFrame(contrasts)
contrasts_df.to_csv('output/viz_contrasts.csv', index=False, encoding='utf-8-sig')
print("‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: viz_contrasts.csv (–∫–æ–Ω—Ç—Ä–∞—Å—Ç—ã –º–µ–∂–¥—É —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º–∏)")

# 3. –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å vs –†–æ—Å—Å—Ç–∞—Ç
top_cross[['municipal_name', 'region_name', 'actual_value', 'expected_value', 'deviation_pct']].to_csv(
    'output/viz_cross_source_discrepancies.csv', index=False, encoding='utf-8-sig'
)
print("‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: viz_cross_source_discrepancies.csv (—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)")

# 4. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∞–Ω–æ–º–∞–ª–∏–π
geo_summary = df.groupby(['region_name', 'anomaly_type']).agg({
    'anomaly_id': 'count',
    'severity_score': 'mean'
}).reset_index()
geo_summary.columns = ['region', 'anomaly_type', 'count', 'avg_severity']
geo_summary.to_csv('output/viz_regional_distribution.csv', index=False, encoding='utf-8-sig')
print("‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: viz_regional_distribution.csv (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º)")

# 5. –î–∞—Ç–∞-–∏—Å—Ç–æ—Ä–∏–∏ –≤ JSON
with open('output/viz_data_stories.json', 'w', encoding='utf-8') as f:
    json.dump(stories, f, ensure_ascii=False, indent=2, default=str)
print("‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: viz_data_stories.json (–≥–æ—Ç–æ–≤—ã–µ –¥–∞—Ç–∞-–∏—Å—Ç–æ—Ä–∏–∏)")

# 6. –°–≤–æ–¥–∫–∞ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
summary = {
    'project_title': '–û —ç—Ç–æ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π, —Å—Ç—Ä–∞–Ω–Ω—ã–π –º–∏—Ä',
    'subtitle': '–°–∞–º—ã–µ –Ω–µ–æ–±—ã—á–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –°–±–µ—Ä–ò–Ω–¥–µ–∫—Å–∞',
    'key_numbers': {
        'total_anomalies': len(df),
        'municipalities': df['territory_id'].nunique(),
        'critical_anomalies': len(critical),
        'cross_source_discrepancies': len(cross_source),
        'remote_territories': len(remote),
        'capital_anomalies': len(capital_anomalies)
    },
    'stories_count': len(stories),
    'data_files': [
        'viz_top50_anomalies.csv',
        'viz_contrasts.csv',
        'viz_cross_source_discrepancies.csv',
        'viz_regional_distribution.csv',
        'viz_data_stories.json'
    ],
    'visualization_ideas': [
        '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –†–æ—Å—Å–∏–∏ —Å –∞–Ω–æ–º–∞–ª–∏—è–º–∏',
        '–†–∞–¥–∞—Ä-—á–∞—Ä—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ù–æ—Ä–∏–ª—å—Å–∫–∞ —Å –¥—Ä—É–≥–∏–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏',
        '–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞: –î–≤–µ –†–æ—Å—Å–∏–∏ (–ê—Ä–±–∞—Ç vs –ë–∏–ª–∏–±–∏–Ω–æ)',
        '–ê–Ω–∏–º–∞—Ü–∏—è: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏',
        'Dashboard —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ —Ç–∏–ø–∞–º –∞–Ω–æ–º–∞–ª–∏–π'
    ],
    'narratives': [s['title'] for s in stories]
}

with open('output/viz_summary.json', 'w', encoding='utf-8') as f:
    json.dump(summary, f, ensure_ascii=False, indent=2)
print("‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: viz_summary.json (—Å–≤–æ–¥–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞)")

# ============================================================================
# –û–¶–ï–ù–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –ö –ü–ï–†–ï–î–ê–ß–ï
# ============================================================================

print("\n" + "=" * 80)
print("‚úÖ –û–¶–ï–ù–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –ö –ü–ï–†–ï–î–ê–ß–ï –ö–û–ú–ê–ù–î–ï –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò")
print("=" * 80)

checklist = {
    '–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã': True,
    '–¢–æ–ø-50 —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π –æ—Ç–æ–±—Ä–∞–Ω—ã': True,
    '–î–∞—Ç–∞-–∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã': len(stories) >= 3,
    '–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—ã –≤—ã–¥–µ–ª–µ–Ω—ã': len(contrasts) > 0,
    '–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã': len(cross_source) > 0,
    '–§–∞–π–ª—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã': True,
    'JSON —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –≥–æ—Ç–æ–≤': True,
    '–ò–¥–µ–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã': True
}

print("\nüìã –ß–µ–∫–ª–∏—Å—Ç:")
for item, status in checklist.items():
    icon = "‚úÖ" if status else "‚ùå"
    print(f"{icon} {item}")

readiness = sum(checklist.values()) / len(checklist) * 100
print(f"\nüéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: {readiness:.0f}%")

if readiness >= 80:
    print("\n‚úÖ –î–ê–ù–ù–´–ï –ì–û–¢–û–í–´ –ö –ü–ï–†–ï–î–ê–ß–ï –ö–û–ú–ê–ù–î–ï –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò!")
    print("\n–ß—Ç–æ –¥–∞–ª—å—à–µ:")
    print("1. –ö–æ–º–∞–Ω–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–∞–µ—Ç 6 —Ñ–∞–π–ª–æ–≤ –∏–∑ output/")
    print("2. –ò—Å–ø–æ–ª—å–∑—É—é—Ç viz_data_stories.json –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞")
    print("3. –°—Ç—Ä–æ—è—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ CSV —Ñ–∞–π–ª–æ–≤")
    print("4. –°–æ–∑–¥–∞—é—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π dashboard –∏–ª–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é")
else:
    print("\n‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π")

print("\n" + "=" * 80)
print("üé® –ü–û–î–ì–û–¢–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê")
print("=" * 80)
